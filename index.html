<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Multi-Modal Analyzer (HTML)</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load React and ReactDOM from CDNs -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Load Babel for JSX transformation in the browser. NOTE: This impacts performance due to client-side transpilation. -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            background-color: #0f172a; /* bg-slate-900 */
        }
        #root:empty::before {
            content: "Loading Application...";
            color: #cbd5e1; /* text-slate-300 */
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: sans-serif;
            font-size: 1.5rem;
        }

        /* Custom styles for markdown rendering */
        .prose h1, .prose h2, .prose h3 {
            font-weight: bold;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            color: #e2e8f0; /* text-slate-200 */
        }
        .prose p {
            margin-bottom: 1em;
            color: #cbd5e1; /* text-slate-300 */
        }
        .prose ul, .prose ol {
            padding-left: 1.5rem;
            list-style: disc;
            margin-bottom: 1em;
            color: #cbd5e1; /* text-slate-300 */
        }
        .prose ol {
            list-style: decimal;
        }
        .prose li {
            margin-bottom: 0.5em;
        }
        .prose strong {
            font-weight: bold;
            color: #f8fafc; /* text-slate-50 */
        }
        .prose em {
            font-style: italic;
            color: #94a3b8; /* text-slate-400 */
        }

        /* Table styling */
        .prose table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            border-radius: 0.5rem;
            overflow: hidden;
            background-color: #1e293b; /* bg-slate-800 */
        }
        .prose th, .prose td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #334155; /* border-slate-700 */
            color: #cbd5e1; /* text-slate-300 */
        }
        .prose th {
            background-color: #0f172a; /* bg-slate-900 */
            font-weight: 600;
            color: #e2e8f0; /* text-slate-200 */
            text-transform: uppercase;
            font-size: 0.75rem;
        }
        .prose tr:nth-child(even) {
            background-color: #1e293b; /* bg-slate-800 */
        }
        .prose tr:hover {
            background-color: #334155; /* bg-slate-700 */
        }
        .prose code {
            background-color: #334155; /* bg-slate-700 */
            color: #f8fafc; /* text-slate-50 */
            padding: 0.2em 0.4em;
            border-radius: 0.3em;
            font-family: monospace;
        }
        .prose pre {
            background-color: #0f172a; /* bg-slate-900 */
            color: #e2e8f0; /* text-slate-200 */
            padding: 1em;
            border-radius: 0.5em;
            overflow-x: auto;
            font-family: monospace;
        }
        /* Make sure br elements don't add too much space */
        .prose br {
            content: "";
            display: block;
            margin-bottom: 0.25em; /* Small margin for line breaks */
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.29.0"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useCallback, useRef, useEffect } = React;
        const ReactDOM = window.ReactDOM;

        // The API key must be obtained exclusively from the environment variable process.env.API_KEY.
        const apiKey = process.env.API_KEY; 
        // const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`; // This is now dynamically built in makeGeminiApiCall

        // --- Gemini API related definitions (mimicking SDK Types for payload construction) ---

        const Type = {
            TYPE_UNSPECIFIED: 'TYPE_UNSPECIFIED',
            STRING: 'STRING',
            NUMBER: 'NUMBER',
            INTEGER: 'INTEGER',
            BOOLEAN: 'BOOLEAN',
            ARRAY: 'ARRAY',
            OBJECT: 'OBJECT',
            NULL: 'NULL',
        };

        const ImageCategory = {
            NETWORK_DIAGRAM: 'NETWORK_DIAGRAM',
            FRUIT: 'FRUIT',
            PULSES: 'PULSES', // ADDED: New category for pulses
            INVOICE: 'INVOICE',
            OTHER: 'OTHER',
            UNKNOWN: 'UNKNOWN',
        };

        const GeneralCategory = {
            LOGO: 'LOGO',
            GENERIC: 'GENERIC',
            CELEBRITY: 'CELEBRITY',
            COOKED_FOOD: 'COOKED_FOOD', // Added for cooked food sub-classification
            ELECTRONIC_ITEM: 'ELECTRONIC_ITEM',
            PLANT: 'PLANT',
            ANIMAL: 'ANIMAL',
            SCENE: 'SCENE',
            MANMADE_OBJECT: 'MANMADE_OBJECT',
        };

        // --- Helper Functions (Ported from services/geminiService.ts and App.tsx) ---

        function fileToGenerativePart(base64, mimeType) {
            return {
                inlineData: {
                    data: base64,
                    mimeType
                },
            };
        }

        // Exponential Backoff Fetch
        const fetchWithRetry = async (url, options, maxRetries = 5) => {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    }
                    // For non-2xx responses, throw error and trigger retry
                    throw new Error(`HTTP error! status: ${response.status}`);
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.floor(Math.random() * 1000);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        };

        async function makeGeminiApiCall(prompt, imagePart = null, config = {}, modelOverride = null) {
            const contents = imagePart ? [{ text: prompt }, imagePart] : [{ text: prompt }];

            const payload = {
                contents: [{
                    role: "user",
                    parts: contents
                }],
                generationConfig: config,
            };

            const response = await fetchWithRetry(
                `https://generativelanguage.googleapis.com/v1beta/models/${modelOverride || 'gemini-2.5-flash-preview-09-2025'}:generateContent?key=${apiKey}`,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }
            );

            const result = await response.json();
            const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

            if (jsonText) {
                try {
                    return JSON.parse(jsonText);
                } catch (e) {
                    console.error("Failed to parse JSON response:", jsonText, e);
                    throw new Error("Received non-JSON output from AI. Please try a clearer image.");
                }
            } else if (result.candidates?.[0]?.finishReason === 'SAFETY') {
                throw new Error("Content was blocked due to safety concerns. Please try a different image or prompt.");
            } else if (result.error) {
                throw new Error(`API Error: ${result.error.message}`);
            } else {
                throw new Error("Could not get a valid response from the AI model.");
            }
        }
        
        // --- Analysis Functions (Ported from services/geminiService.ts) ---

        async function classifyImage(base64, mimeType) {
            const imagePart = fileToGenerativePart(base64, mimeType);
            // MODIFIED: Added "PULSES" to the classification prompt
            const prompt = `Analyze the image and classify it into one of the following categories: "NETWORK_DIAGRAM", "FRUIT", "PULSES", "INVOICE", or "OTHER". Respond with only the category name.`;

            // No specific responseSchema for classification, expect plain text
            const response = await fetchWithRetry(
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            role: "user",
                            parts: [{ text: prompt }, imagePart]
                        }],
                    })
                }
            );
            const result = await response.json();
            const categoryText = result.candidates?.[0]?.content?.parts?.[0]?.text;

            if (categoryText) {
                const category = categoryText.trim().toUpperCase();
                if (Object.values(ImageCategory).includes(category)) {
                    return category;
                }
            } else if (result.error) {
                throw new Error(`API Error: ${result.error.message}`);
            }
            return ImageCategory.OTHER;
        }

        async function analyzeNetworkDiagram(base64, mimeType) {
            const imagePart = fileToGenerativePart(base64, mimeType);
            const prompt = `Analyze this network diagram. Identify all devices, their connections, and provide a summary.
            For each device and connection, provide a confidence level ('High', 'Medium', 'Low') based on how clearly it is depicted in the diagram.
            Also, generate a basic Terraform HCL configuration for the identified infrastructure. The Terraform HCL code must be well-formatted with proper indentation and newlines to ensure readability.
            Respond in JSON format.`;

            const schema = {
                type: Type.OBJECT,
                properties: {
                    summary: { type: Type.STRING, description: "A brief overview of the network topology." },
                    devices: {
                        type: Type.ARRAY,
                        description: "An array of objects, each with id, type, name, details, and confidence.",
                        items: {
                            type: Type.OBJECT,
                            properties: {
                                id: { type: Type.STRING },
                                type: { type: Type.STRING },
                                name: { type: Type.STRING },
                                details: { type: Type.STRING },
                                confidence: { type: Type.STRING, description: "Confidence level (High, Medium, Low) for this detection." }
                            },
                            required: ['id', 'type', 'name', 'details']
                        }
                    },
                    connections: {
                        type: Type.ARRAY,
                        description: "An array of objects, each specifying 'from' and 'to' using device ids, protocol, and confidence.",
                        items: {
                            type: Type.OBJECT,
                            properties: {
                                from: { type: Type.STRING },
                                to: { type: Type.STRING },
                                protocol: { type: Type.STRING },
                                confidence: { type: Type.STRING, description: "Confidence level (High, Medium, Low) for this detection." }
                            },
                            required: ['from', 'to', 'protocol']
                        }
                    },
                    terraformCode: { type: Type.STRING, description: "A string containing the well-formatted HCL code." }
                },
                required: ['summary', 'devices', 'connections', 'terraformCode']
            };

            return makeGeminiApiCall(prompt, imagePart, { responseMimeType: "application/json", responseSchema: schema });
        }


        async function analyzeFruit(base64, mimeType) {
            const imagePart = fileToGenerativePart(base64, mimeType);
            const prompt = `Act as an expert produce inspector. Analyze the fruit, vegetable, or pulse in the image. Provide its name, description, nutritional info (calories, sugar), and key vitamins. Assess its freshness and estimate its shelf life from a consumer and vendor perspective. Provide an overall confidence score ('High', 'Medium', 'Low') for this analysis based on the image quality and clarity. Finally, include a disclaimer stating that this analysis is based on a static 2D image.
            Respond in JSON format.`;

            const schema = {
                type: Type.OBJECT,
                properties: {
                    fruitName: { type: Type.STRING, description: "The name of the fruit, vegetable, or pulse." },
                    description: { type: Type.STRING, description: "A short description." },
                    calories: { type: Type.NUMBER, description: "Estimated calories per 100g (as a number)." },
                    sugar: { type: Type.NUMBER, description: "Estimated grams of sugar per 100g (as a number)." },
                    vitamins: {
                        type: Type.ARRAY,
                        description: "An array of strings listing key vitamins.",
                        items: { type: Type.STRING }
                    },
                    freshness: { type: Type.STRING, description: "An assessment of the item's freshness and ripeness." },
                    shelfLife: { type: Type.STRING, description: "Estimated shelf life from a consumer and vendor perspective." },
                    analysisDisclaimer: { type: Type.STRING, description: "A disclaimer about the analysis being based on a static image." },
                    confidence: { type: Type.STRING, description: "Overall confidence in the analysis (High, Medium, Low)." }
                },
                required: ['fruitName', 'description', 'calories', 'sugar', 'vitamins', 'freshness', 'shelfLife', 'analysisDisclaimer']
            };

            return makeGeminiApiCall(prompt, imagePart, { responseMimeType: "application/json", responseSchema: schema });
        }

        // ADDED: New function for Pulse Analysis
        async function analyzePulses(base64, mimeType) {
            const imagePart = fileToGenerativePart(base64, mimeType);
            const prompt = `Act as an expert agricultural analyst specializing in pulses. Analyze the pulse in the image.
            Provide its specific name, type, and variety.
            Generate a detailed identification, quality & purity assessment, overall quality assessment, and key nutrition facts (per 100g serving).
            For quality assessment, estimate foreign matter, defects/damage percentage, uniformity of size, and moisture level if visual cues allow.
            Provide an overall confidence score ('High', 'Medium', 'Low') for this analysis based on the image quality and clarity.
            Finally, include a disclaimer stating that this analysis is based on a static 2D image.
            Respond in JSON format according to the provided schema.`;

            // ADDED: Schema for Pulse Analysis
            const schema = {
                type: Type.OBJECT,
                properties: {
                    pulseName: { type: Type.STRING, description: "The common name of the pulse (e.g., 'Red Lentil', 'Chickpea')." },
                    description: { type: Type.STRING, description: "A brief descriptive summary of the pulse." },
                    identification: {
                        type: Type.OBJECT,
                        properties: {
                            type: { type: Type.STRING, description: "General type (e.g., 'Lentil', 'Bean', 'Pea')." },
                            variety: { type: Type.STRING, description: "Specific variety (e.g., 'Masoor Dal', 'Kabuli Chickpea')." },
                            estimatedSizeWeight: { type: Type.STRING, description: "Estimated size range or weight per unit (e.g., '5-7mm', 'approx 0.3g per seed')." },
                        },
                        required: ['type', 'variety', 'estimatedSizeWeight'],
                    },
                    qualityPurityAssessment: {
                        type: Type.OBJECT,
                        properties: {
                            observedForeignMatter: { type: Type.STRING, description: "Description of any observed foreign matter (e.g., 'Minimal', 'Some chaff')." },
                            defectsDamagePercentage: { type: Type.STRING, description: "Estimated percentage of defects/damage (e.g., 'Less than 2%', 'Around 5%')." },
                            uniformityOfSize: { type: Type.STRING, description: "Assessment of size uniformity (e.g., 'Highly uniform', 'Moderately varied')." },
                            estimatedMoistureLevel: { type: Type.STRING, description: "Estimated moisture level if visual cues allow (e.g., 'Low', 'Medium')." },
                        },
                        required: ['observedForeignMatter', 'defectsDamagePercentage', 'uniformityOfSize', 'estimatedMoistureLevel'],
                    },
                    overallQualityAssessment: { type: Type.STRING, description: "An overall summary of the pulse's quality (e.g., 'Excellent quality, high purity', 'Good quality suitable for processing')." },
                    keyNutritionFactsPer100g: {
                        type: Type.OBJECT,
                        properties: {
                            estimatedProtein: { type: Type.STRING, description: "Estimated protein per 100g (e.g., '24g')." },
                            estimatedFiber: { type: Type.STRING, description: "Estimated fiber per 100g (e.g., '16g')." },
                            estimatedCarbs: { type: Type.STRING, description: "Estimated carbohydrates per 100g (e.g., '60g')." },
                            estimatedCalories: { type: Type.STRING, description: "Estimated calories per 100g (e.g., '340 kcal')." },
                            keyMineralsVitamins: { type: Type.STRING, description: "Key minerals and vitamins (e.g., 'Iron, Magnesium, Folate')." },
                        },
                        required: ['estimatedProtein', 'estimatedFiber', 'estimatedCarbs', 'estimatedCalories', 'keyMineralsVitamins'],
                    },
                    confidence: { type: Type.STRING, description: "Overall confidence in the analysis (High, Medium, Low)." },
                    analysisDisclaimer: { type: Type.STRING, description: "A disclaimer about the analysis being based on a static image." },
                },
                required: [
                    'pulseName', 'description', 'identification', 'qualityPurityAssessment',
                    'overallQualityAssessment', 'keyNutritionFactsPer100g', 'confidence', 'analysisDisclaimer'
                ],
            };

            return makeGeminiApiCall(prompt, imagePart, { responseMimeType: "application/json", responseSchema: schema });
        }


        async function analyzeInvoice(base64, mimeType) {
            const imagePart = fileToGenerativePart(base64, mimeType);
            const prompt = `Act as a meticulous data entry specialist. Analyze the invoice or bill in the image. Extract the vendor name, invoice date, total amount, and tax amount. Identify the currency and provide its ISO 4217 code (e.g., USD, EUR, INR). Identify all line items, including their description, quantity, unit price, and total price. Provide an overall confidence score ('High', 'Medium', 'Low') based on the clarity of the document. Respond in JSON format.`;

            const schema = {
                type: Type.OBJECT,
                properties: {
                    vendorName: { type: Type.STRING },
                    invoiceDate: { type: Type.STRING },
                    totalAmount: { type: Type.NUMBER },
                    taxAmount: { type: Type.NUMBER, nullable: true },
                    currency: { type: Type.STRING, description: "The ISO 4217 currency code (e.g., USD, EUR, INR)." },
                    lineItems: {
                        type: Type.ARRAY,
                        items: {
                            type: Type.OBJECT,
                            properties: {
                                description: { type: Type.STRING },
                                quantity: { type: Type.NUMBER },
                                unitPrice: { type: Type.NUMBER },
                                totalPrice: { type: Type.NUMBER },
                            },
                            required: ['description', 'quantity', 'unitPrice', 'totalPrice'],
                        },
                    },
                    confidence: { type: Type.STRING, description: "Overall confidence in the extraction (High, Medium, Low)." }
                },
                required: ['vendorName', 'invoiceDate', 'totalAmount', 'currency', 'lineItems'],
            };
            
            return makeGeminiApiCall(prompt, imagePart, { responseMimeType: "application/json", responseSchema: schema });
        }

        async function analyzeGeneralImage(base64, mimeType) {
            const imagePart = fileToGenerativePart(base64, mimeType);

            // Step 1: Sub-classification
            // Updated prompt to include more GeneralCategory types
            const subClassifyPrompt = `Is the main subject of this image a known celebrity, a company or product logo, a cooked food dish, an electronic item, a plant, an animal, a general scene, or a manmade object? Respond with only "CELEBRITY", "LOGO", "COOKED_FOOD", "ELECTRONIC_ITEM", "PLANT", "ANIMAL", "SCENE", or "MANMADE_OBJECT".`;
            const subClassifyResponse = await fetchWithRetry(
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            role: "user",
                            parts: [{ text: subClassifyPrompt }, imagePart]
                        }],
                    })
                }
            );
            const subCategoryText = await subClassifyResponse.json();
            const subCategory = subCategoryText.candidates?.[0]?.content?.parts?.[0]?.text?.trim()?.toUpperCase();

            let analysisResult;

            switch (subCategory) {
                case GeneralCategory.LOGO:
                    // Step 2a: Analyze as a Logo
                    const logoPrompt = `Act as a brand recognition expert. Analyze the logo in the image. Identify the company and/or product it represents. Provide details about the company, its industry, and an official website if possible. Provide an overall confidence score ('High', 'Medium', 'Low') for this analysis. If you cannot identify the logo, provide your best guess but with a 'Low' confidence. Respond in JSON format.`;
                    const logoSchema = {
                        type: Type.OBJECT,
                        properties: {
                            companyName: { type: Type.STRING },
                            productName: { type: Type.STRING, nullable: true },
                            description: { type: Type.STRING },
                            industry: { type: Type.STRING },
                            website: { type: Type.STRING, nullable: true },
                            confidence: { type: Type.STRING }
                        },
                        required: ['companyName', 'description', 'industry']
                    };
                    analysisResult = await makeGeminiApiCall(logoPrompt, imagePart, { responseMimeType: "application/json", responseSchema: logoSchema });
                    return { subCategory: GeneralCategory.LOGO, ...analysisResult };

                case GeneralCategory.CELEBRITY:
                    // Step 2b: Analyze as a Celebrity
                    const celebrityPrompt = `Act as a pop culture and biography expert. Analyze the image of the celebrity. Identify them and provide their name, what they are known for (e.g., profession), a brief biography, a list of a few notable works (movies, songs, achievements), and an official website if one exists. Provide an overall confidence score ('High', 'Medium', 'Low'). If you cannot identify the person with high confidence, state that clearly and provide your best guess with a 'Low' confidence. Respond in JSON format.`;
                    const celebritySchema = {
                        type: Type.OBJECT,
                        properties: {
                            name: { type: Type.STRING },
                            knownFor: { type: Type.STRING, description: "Profession(s) or what the person is known for." },
                            biography: { type: Type.STRING },
                            notableWorks: { type: Type.ARRAY, items: { type: Type.STRING } },
                            officialWebsite: { type: Type.STRING, nullable: true },
                            confidence: { type: Type.STRING }
                        },
                        required: ['name', 'knownFor', 'biography', 'notableWorks']
                    };
                    analysisResult = await makeGeminiApiCall(celebrityPrompt, imagePart, { responseMimeType: "application/json", responseSchema: celebritySchema });
                    return { subCategory: GeneralCategory.CELEBRITY, ...analysisResult };

                case GeneralCategory.COOKED_FOOD:
                    const cookedFoodPrompt = `Act as a culinary expert. Analyze the cooked food dish in the image. Identify the dish name, estimated main ingredients, a nutrition estimate (calories, protein, carbs, fat per typical serving), a simple cooking process/recipe (step-by-step), and alert for common allergens if visible or typically present. Provide an overall confidence score ('High', 'Medium', 'Low'). Respond in JSON format.`;
                    const cookedFoodSchema = {
                        type: Type.OBJECT,
                        properties: {
                            dishName: { type: Type.STRING },
                            estimatedIngredients: { type: Type.ARRAY, items: { type: Type.STRING } },
                            nutritionEstimate: {
                                type: Type.OBJECT,
                                properties: {
                                    calories: { type: Type.NUMBER },
                                    protein: { type: Type.NUMBER },
                                    carbs: { type: Type.NUMBER },
                                    fat: { type: Type.NUMBER }
                                },
                                required: ['calories', 'protein', 'carbs', 'fat']
                            },
                            cookingProcess: { type: Type.ARRAY, items: { type: Type.STRING } },
                            allergenAlert: { type: Type.ARRAY, items: { type: Type.STRING } },
                            confidence: { type: Type.STRING }
                        },
                        required: ['dishName', 'estimatedIngredients', 'nutritionEstimate', 'cookingProcess']
                    };
                    analysisResult = await makeGeminiApiCall(cookedFoodPrompt, imagePart, { responseMimeType: "application/json", responseSchema: cookedFoodSchema });
                    return { subCategory: GeneralCategory.COOKED_FOOD, ...analysisResult };

                // Handle other generic categories similarly if needed, or fall through to GENERIC
                case GeneralCategory.ELECTRONIC_ITEM:
                case GeneralCategory.PLANT:
                case GeneralCategory.ANIMAL:
                case GeneralCategory.SCENE:
                case GeneralCategory.MANMADE_OBJECT:
                default: // Fallback to generic if subCategory not explicitly handled or recognized
                    const genericPrompt = `Describe the image in detail. Provide a general description and a few relevant tags. Provide an overall confidence score ('High', 'Medium', 'Low') for your description based on the clarity of the image. Respond in JSON format.`;
                    const genericSchema = {
                        type: Type.OBJECT,
                        properties: {
                            description: { type: Type.STRING },
                            tags: { type: Type.ARRAY, items: { type: Type.STRING } },
                            details: { type: Type.ARRAY, items: { type: Type.STRING }, nullable: true }, // Added for more specific generic details
                            confidence: { type: Type.STRING }
                        },
                        required: ['description', 'tags']
                    };
                    analysisResult = await makeGeminiApiCall(genericPrompt, imagePart, { responseMimeType: "application/json", responseSchema: genericSchema });
                    const finalSubCategory = subCategory === 'ELECTRONIC_ITEM' ? GeneralCategory.ELECTRONIC_ITEM :
                                             subCategory === 'PLANT' ? GeneralCategory.PLANT :
                                             subCategory === 'ANIMAL' ? GeneralCategory.ANIMAL :
                                             subCategory === 'SCENE' ? GeneralCategory.SCENE :
                                             subCategory === 'MANMADE_OBJECT' ? GeneralCategory.MANMADE_OBJECT :
                                             GeneralCategory.GENERIC;
                    return { subCategory: finalSubCategory, ...analysisResult };
            }
        }


        // --- React Components (Ported from components/*) ---

        const Header = () => {
            const LogoIcon = () => (
                <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8 text-sky-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                    <path strokeLinecap="round" strokeLinejoin="round" d="M9.75 3.104l-2.286 9.144a3.75 3.75 0 003.75 4.498h1.5A3.75 3.75 0 0016.5 12.25l-2.286-9.144a3.75 3.75 0 00-4.464 0z" />
                    <path strokeLinecap="round" strokeLinejoin="round" d="M12 21a9.002 9.002 0 008.13-5.253M3.87 15.747A9.002 9.002 0 0012 21" />
                </svg>
            );

            return (
                <header className="bg-slate-900/70 backdrop-blur-lg p-4 border-b border-slate-700 sticky top-0 z-10">
                    <div className="container mx-auto flex items-center gap-4">
                        <LogoIcon />
                        <h1 className="text-2xl font-bold text-slate-100 tracking-tight">
                            AI Multi-Modal Analyzer
                        </h1>
                    </div>
                </header>
            );
        };

        const Spinner = () => {
            return (
                <div className="flex justify-center items-center h-full">
                    <div className="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-sky-500"></div>
                </div>
            );
        };

        const CodeBlock = ({ code, language = 'json' }) => {
            const [copied, setCopied] = useState(false);

            const handleCopy = () => {
                navigator.clipboard.writeText(code).then(() => {
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                }).catch(err => console.error("Failed to copy text: ", err));
            };

            const CopyIcon = () => (
                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                    <path strokeLinecap="round" strokeLinejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                </svg>
            );
            
            const CheckIcon = () => (
                 <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                    <path strokeLinecap="round" strokeLinejoin="round" d="M5 13l4 4L19 7" />
                </svg>
            );

            return (
                <div className="bg-slate-800 rounded-lg relative font-mono text-sm">
                    <div className="flex justify-between items-center px-4 py-2 bg-slate-900/50 rounded-t-lg">
                        <span className="text-slate-400">{language}</span>
                        <button
                            onClick={handleCopy}
                            className="flex items-center gap-2 px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded text-slate-200 text-xs transition-colors"
                        >
                            {copied ? <CheckIcon/> : <CopyIcon/>}
                            {copied ? 'Copied!' : 'Copy Code'}
                        </button>
                    </div>
                    <pre className="p-4 overflow-x-auto">
                        <code className="text-slate-200 whitespace-pre-wrap">{code}</code>
                    </pre>
                </div>
            );
        };

        const ImageInput = ({ onImageSelect, isProcessing }) => {
            const [mode, setMode] = useState('upload');
            const [isDragging, setIsDragging] = useState(false);
            const [isCameraOn, setIsCameraOn] = useState(false);
            const [isInitializingCamera, setIsInitializingCamera] = useState(false);
            const [cameraError, setCameraError] = useState(null);

            const fileInputRef = useRef(null);
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const streamRef = useRef(null);
            
            useEffect(() => {
                return () => {
                    if (streamRef.current) {
                        streamRef.current.getTracks().forEach(track => track.stop());
                    }
                };
            }, []);

            const stopCamera = useCallback(() => {
                if (streamRef.current) {
                    streamRef.current.getTracks().forEach(track => track.stop());
                    streamRef.current = null;
                }
                setIsCameraOn(false);
            }, []);

            const handleModeChange = (newMode) => {
                if (isProcessing) return;
                setMode(newMode);
                if (newMode === 'upload' && isCameraOn) {
                    stopCamera();
                }
            };

            const handleFile = useCallback((file) => {
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const result = e.target?.result;
                        const base64 = result.split(',')[1];
                        if (base64) {
                            onImageSelect(base64, file.type);
                        }
                    };
                    reader.readAsDataURL(file);
                } else {
                    alert("Invalid file type. Please select an image.");
                }
            }, [onImageSelect]);

            const handleDragEnter = (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (!isProcessing) setIsDragging(true);
            };

            const handleDragLeave = (e) => {
                e.preventDefault(); e.stopPropagation(); setIsDragging(false);
            };
            
            const handleDragOver = (e) => {
                e.preventDefault(); e.stopPropagation();
            };

            const handleDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDragging(false);
                if (isProcessing) return;
                if (e.dataTransfer.files?.[0]) {
                    handleFile(e.dataTransfer.files[0]);
                    e.dataTransfer.clearData();
                }
            };

            const handleFileChange = (e) => {
                if (e.target.files?.[0]) {
                    handleFile(e.target.files[0]);
                }
            };

            const handleClickUpload = () => {
                if (!isProcessing) fileInputRef.current?.click();
            };

            const startCamera = useCallback(async () => {
                if (isProcessing || isInitializingCamera) return;
                setIsInitializingCamera(true);
                setCameraError(null);
                try {
                    if (streamRef.current) {
                        streamRef.current.getTracks().forEach(track => track.stop());
                    }
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    streamRef.current = stream;
                    if (videoRef.current) {
                        videoRef.current.srcObject = stream;
                    }
                    setIsCameraOn(true);
                } catch (err) {
                    console.error("Camera error:", err);
                    setCameraError("Could not access camera. Please check permissions and try again.");
                    setIsCameraOn(false);
                } finally {
                    setIsInitializingCamera(false);
                }
            }, [isProcessing, isInitializingCamera]);

            const captureImage = () => {
                if (!videoRef.current || !canvasRef.current) return;
                const video = videoRef.current;
                const canvas = canvasRef.current;
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const context = canvas.getContext('2d');
                if (context) {
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const dataUrl = canvas.toDataURL('image/jpeg');
                    const base64 = dataUrl.split(',')[1];
                    onImageSelect(base64, 'image/jpeg');
                    stopCamera();
                }
            };

            const UploadIcon = () => (
                <svg xmlns="http://www.w3.org/2000/svg" className="h-12 w-12 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1}>
                    <path strokeLinecap="round" strokeLinejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                </svg>
            );
            
            const CameraIcon = ({className}) => (
                <svg xmlns="http://www.w3.org/2000/svg" className={className || "h-6 w-6"} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                    <path strokeLinecap="round" strokeLinejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                    <path strokeLinecap="round" strokeLinejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            );

            const InlineSpinner = () => (
                <div className="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-sky-500"></div>
            );

            return (
                <div className="bg-slate-800 p-6 rounded-lg shadow-lg">
                    <div className="mb-4 flex p-1 bg-slate-900 rounded-lg">
                        <button
                            onClick={() => handleModeChange('upload')}
                            disabled={isProcessing}
                            className={`w-1/2 py-2 px-4 rounded-md text-sm font-medium transition-colors ${mode === 'upload' ? 'bg-sky-600 text-white' : 'text-slate-300 hover:bg-slate-700'} disabled:opacity-50`}
                        >
                            File Upload
                        </button>
                        <button
                            onClick={() => handleModeChange('scan')}
                            disabled={isProcessing}
                            className={`w-1/2 py-2 px-4 rounded-md text-sm font-medium transition-colors ${mode === 'scan' ? 'bg-sky-600 text-white' : 'text-slate-300 hover:bg-slate-700'} disabled:opacity-50`}
                        >
                            Live Scan
                        </button>
                    </div>
                    
                    {mode === 'upload' ? (
                        <div
                            onDragEnter={handleDragEnter}
                            onDragLeave={handleDragLeave}
                            onDragOver={handleDragOver}
                            onDrop={handleDrop}
                            onClick={handleClickUpload}
                            className={`border-2 border-dashed rounded-lg p-8 text-center transition-colors
                                ${isDragging ? 'border-sky-500 bg-slate-700/50' : 'border-slate-600 hover:border-slate-500'}
                                ${isProcessing ? 'cursor-not-allowed opacity-50' : 'cursor-pointer'}`}
                        >
                            <input ref={fileInputRef} type="file" accept="image/*" onChange={handleFileChange} className="hidden" disabled={isProcessing} />
                            <div className="flex flex-col items-center">
                                <UploadIcon />
                                <p className="mt-2 text-slate-400">
                                    <span className="font-semibold text-sky-400">Click to upload</span> or drag and drop
                                </p>
                                <p className="text-xs text-slate-500">PNG, JPG, GIF, WebP</p>
                            </div>
                        </div>
                    ) : (
                        <div className="space-y-4">
                            <div className="w-full aspect-video bg-black rounded-lg overflow-hidden flex items-center justify-center relative">
                                <video ref={videoRef} autoPlay playsInline muted className={`w-full h-full object-cover ${!isCameraOn && 'hidden'}`}></video>
                                {isInitializingCamera && (
                                    <div className="flex flex-col items-center text-slate-300">
                                        <InlineSpinner />
                                        <span className="mt-2">Initializing camera...</span>
                                    </div>
                                )}
                                {!isCameraOn && !isInitializingCamera && (
                                   <div className="text-slate-500 text-center">
                                        <CameraIcon className="h-16 w-16 mx-auto" />
                                        <p>Camera is off</p>
                                   </div>
                                )}

                                {isCameraOn && (
                                    <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                                        <div className="relative w-3/4 h-3/4 max-w-sm max-h-sm border-4 border-dashed border-sky-500 rounded-lg flex items-center justify-center bg-black/30 text-slate-300 text-sm">
                                            <p>Center object here</p>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {cameraError && <p className="text-red-400 text-center text-sm">{cameraError}</p>}
                            
                            {!isCameraOn ? (
                                <button onClick={startCamera} disabled={isProcessing || isInitializingCamera} className="w-full flex items-center justify-center bg-slate-600 hover:bg-slate-700 disabled:bg-slate-500 disabled:cursor-wait text-white font-bold py-3 px-4 rounded-lg transition-colors">
                                    <CameraIcon className="h-5 w-5 mr-2"/>
                                    {isInitializingCamera ? 'Starting...' : 'Start Camera'}
                                </button>
                            ) : (
                                <div className="grid grid-cols-2 gap-4">
                                    <button onClick={captureImage} disabled={isProcessing} className="w-full flex items-center justify-center bg-sky-600 hover:bg-sky-700 disabled:bg-slate-500 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                                        Capture Image
                                    </button>
                                     <button onClick={stopCamera} disabled={isProcessing} className="w-full flex items-center justify-center bg-red-600 hover:bg-red-700 disabled:bg-slate-500 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                                        Stop Camera
                                    </button>
                                </div>
                            )}
                            <canvas ref={canvasRef} className="hidden"></canvas>
                        </div>
                    )}
                </div>
            );
        };
        
        const ErrorView = ({ message }) => (
            <div className="flex flex-col items-center justify-center h-full bg-slate-800 p-6 rounded-lg border border-red-500/30">
                <svg xmlns="http://www.w3.org/2000/svg" className="h-12 w-12 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                    <path strokeLinecap="round" strokeLinejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h3 className="text-xl font-semibold text-red-300 mt-4">Analysis Failed</h3>
                <p className="text-slate-400 text-center mt-2">{message}</p>
            </div>
        );

        const AnalysisResult = ({ result, isLoading, error }) => {
            const [activeResultTab, setActiveResultTab] = useState('summary');

            const AnalyzeIcon = () => (
                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                    <path strokeLinecap="round" strokeLinejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.375 3.375 0 0014 18.442V21.75a1.5 1.5 0 01-3 0v-3.308c0-.442.07-.874.208-1.288l.548-.547z" />
                </svg>
            );

            const CodeIcon = () => (
                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                    <path strokeLinecap="round" strokeLinejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 4l-4 4 4 4" />
                </svg>
            );

            const NetworkIcon = () => (
                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <rect x="2" y="2" width="20" height="20" rx="2" ry="2"></rect>
                    <line x1="12" y1="6" x2="12" y2="18"></line>
                    <line x1="6" y1="12" x2="18" y2="12"></line>
                </svg>
            );

            const FruitIcon = () => (
                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M12 6c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4z"></path>
                    <path d="M12 18c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z"></path>
                    <path d="M12 2v2"></path>
                    <path d="M12 20v2"></path>
                    <path d="M20 12h2"></path>
                    <path d="M2 12h2"></path>
                </svg>
            );

            // ADDED: New icon for Pulses (reusing Wheat icon)
            const PulsesIcon = () => (
                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M2 22s1-2 5-2 5 2 5 2V4c0-2-1.5-3-3-3-1.5 0-3 1-3 3v16" />
                    <path d="M15 5.5a3.5 3.5 0 1 1 3.5 3.5v10.5" />
                    <path d="M18.5 9a3.5 3.5 0 1 1 3.5 3.5V22" />
                </svg>
            );

            const InvoiceIcon = () => (
                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <line x1="10" y1="9" x2="8" y2="9"></line>
                </svg>
            );

            const GeneralIcon = () => (
                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                    <line x1="9" y1="9" x2="9.01" y2="9"></line>
                    <line x1="15" y1="9" x2="15.01" y2="9"></line>
                </svg>
            );

            if (isLoading) {
                return (
                    <div className="bg-slate-800 p-6 rounded-lg shadow-lg h-full flex flex-col justify-center items-center">
                        <Spinner />
                        <p className="mt-4 text-slate-400">Analyzing image, please wait...</p>
                    </div>
                );
            }

            if (error) {
                return <ErrorView message={error} />;
            }

            if (!result) {
                return (
                    <div className="bg-slate-800 p-6 rounded-lg shadow-lg h-full flex flex-col justify-center items-center text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-16 w-16 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1}>
                          <path strokeLinecap="round" strokeLinejoin="round" d="M9.75 3.104l-2.286 9.144a3.75 3.75 0 003.75 4.498h1.5A3.75 3.75 0 0016.5 12.25l-2.286-9.144a3.75 3.75 0 00-4.464 0z" />
                          <path strokeLinecap="round" strokeLinejoin="round" d="M12 21a9.002 9.002 0 008.13-5.253M3.87 15.747A9.002 9.002 0 0012 21" />
                        </svg>
                        <h2 className="mt-4 text-xl font-semibold text-slate-300">Awaiting Analysis</h2>
                        <p className="text-slate-500 mt-1">Upload an image and click "Analyze Image" to see the results here.</p>
                    </div>
                );
            }

            const renderDetails = () => {
                if (!result) return null;

                switch (result.category) {
                    case ImageCategory.NETWORK_DIAGRAM:
                        const networkResult = result; // Type will be inferred correctly in TSX.
                        return (
                            <>
                                <h3 className="text-xl font-semibold text-slate-200 mb-2 flex items-center">
                                    <NetworkIcon /> Network Diagram Analysis
                                </h3>
                                <div className="prose mb-4">
                                    <h4>Summary</h4>
                                    <p>{networkResult.summary}</p>
                                    {networkResult.devices && networkResult.devices.length > 0 && (
                                        <>
                                            <h4>Devices</h4>
                                            <ul>
                                                {networkResult.devices.map((device, i) => (
                                                    <li key={i}><strong>{device.name}</strong> ({device.type}, ID: {device.id}) - {device.details} (Confidence: {device.confidence || 'N/A'})</li>
                                                ))}
                                            </ul>
                                        </>
                                    )}
                                    {networkResult.connections && networkResult.connections.length > 0 && (
                                        <>
                                            <h4>Connections</h4>
                                            <ul>
                                                {networkResult.connections.map((conn, i) => (
                                                    <li key={i}>From {conn.from} to {conn.to} via {conn.protocol} (Confidence: {conn.confidence || 'N/A'})</li>
                                                ))}
                                            </ul>
                                        </>
                                    )}
                                </div>
                                {activeResultTab === 'code' && networkResult.terraformCode && (
                                    <>
                                        <h3 className="text-xl font-semibold text-slate-200 mb-2 flex items-center">
                                            <CodeIcon /> Terraform HCL Code
                                        </h3>
                                        <CodeBlock code={networkResult.terraformCode} language="hcl" />
                                    </>
                                )}
                            </>
                        );
                    case ImageCategory.FRUIT:
                        const fruitResult = result; // Type will be inferred correctly in TSX.
                        return (
                            <>
                                <h3 className="text-xl font-semibold text-slate-200 mb-2 flex items-center">
                                    <FruitIcon /> Fruit Analysis
                                </h3>
                                <div className="prose">
                                    <p className="mb-3 text-sky-400 font-medium">
                                        Fruit Name: <span className="font-bold">{fruitResult.fruitName}</span>
                                    </p>
                                    <h4>Description</h4>
                                    <p>{fruitResult.description}</p>
                                    <h4>Nutritional Information (per 100g)</h4>
                                    <ul>
                                        <li>Calories: {fruitResult.calories} kcal</li>
                                        <li>Sugar: {fruitResult.sugar} g</li>
                                        <li>Vitamins: {fruitResult.vitamins?.join(', ')}</li>
                                    </ul>
                                    <h4>Freshness & Shelf Life</h4>
                                    <ul>
                                        <li>Freshness: {fruitResult.freshness}</li>
                                        <li>Estimated Shelf Life: {fruitResult.shelfLife}</li>
                                    </ul>
                                    <p className="text-sm text-slate-500 mt-4">
                                        <em>Disclaimer: {fruitResult.analysisDisclaimer}</em>
                                    </p>
                                    <p className="text-sm text-slate-500">
                                        Confidence: {fruitResult.confidence || 'N/A'}
                                    </p>
                                </div>
                            </>
                        );
                    // ADDED: New case for PULSES rendering
                    case ImageCategory.PULSES:
                        const pulseResult = result; // Type will be inferred correctly in TSX.
                        return (
                            <>
                                <h3 className="text-xl font-semibold text-slate-200 mb-2 flex items-center">
                                    <PulsesIcon /> Pulse Analysis
                                </h3>
                                <div className="prose">
                                    <p className="mb-3 text-sky-400 font-medium">
                                        Pulse Name: <span className="font-bold">{pulseResult.pulseName}</span>
                                    </p>
                                    <h4>Description</h4>
                                    <p>{pulseResult.description}</p>
                                    <h4>Identification</h4>
                                    <ul>
                                        <li>Type: {pulseResult.identification.type}</li>
                                        <li>Variety: {pulseResult.identification.variety}</li>
                                        <li>Estimated Size/Weight: {pulseResult.identification.estimatedSizeWeight}</li>
                                    </ul>
                                    <h4>Quality & Purity Assessment</h4>
                                    <ul>
                                        <li>Observed Foreign Matter: {pulseResult.qualityPurityAssessment.observedForeignMatter}</li>
                                        <li>Defects/Damage: {pulseResult.qualityPurityAssessment.defectsDamagePercentage}</li>
                                        <li>Uniformity of Size: {pulseResult.qualityPurityAssessment.uniformityOfSize}</li>
                                        <li>Estimated Moisture Level: {pulseResult.qualityPurityAssessment.estimatedMoistureLevel}</li>
                                    </ul>
                                    <h4>Overall Quality Assessment</h4>
                                    <p>{pulseResult.overallQualityAssessment}</p>
                                    <h4>Key Nutrition Facts (per 100g)</h4>
                                    <ul>
                                        <li>Protein: {pulseResult.keyNutritionFactsPer100g.estimatedProtein}</li>
                                        <li>Fiber: {pulseResult.keyNutritionFactsPer100g.estimatedFiber}</li>
                                        <li>Carbs: {pulseResult.keyNutritionFactsPer100g.estimatedCarbs}</li>
                                        <li>Calories: {pulseResult.keyNutritionFactsPer100g.estimatedCalories}</li>
                                        <li>Minerals/Vitamins: {pulseResult.keyNutritionFactsPer100g.keyMineralsVitamins}</li>
                                    </ul>
                                    <p className="text-sm text-slate-500 mt-4">
                                        <em>Disclaimer: {pulseResult.analysisDisclaimer}</em>
                                    </p>
                                    <p className="text-sm text-slate-500">
                                        Confidence: {pulseResult.confidence || 'N/A'}
                                    </p>
                                </div>
                            </>
                        );
                    case ImageCategory.INVOICE:
                        const invoiceResult = result; // Type will be inferred correctly in TSX.
                        return (
                            <>
                                <h3 className="text-xl font-semibold text-slate-200 mb-2 flex items-center">
                                    <InvoiceIcon /> Invoice Analysis
                                </h3>
                                <div className="prose">
                                    <p className="mb-3 text-sky-400 font-medium">
                                        Vendor: <span className="font-bold">{invoiceResult.vendorName}</span>
                                    </p>
                                    <p>Invoice Date: {invoiceResult.invoiceDate}</p>
                                    <p>Total Amount: {invoiceResult.totalAmount} {invoiceResult.currency}</p>
                                    {invoiceResult.taxAmount !== null && <p>Tax Amount: {invoiceResult.taxAmount} {invoiceResult.currency}</p>}
                                    {invoiceResult.lineItems && invoiceResult.lineItems.length > 0 && (
                                        <>
                                            <h4>Line Items</h4>
                                            <table>
                                                <thead>
                                                    <tr>
                                                        <th>Description</th>
                                                        <th>Qty</th>
                                                        <th>Unit Price</th>
                                                        <th>Total Price</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {invoiceResult.lineItems.map((item, i) => (
                                                        <tr key={i}>
                                                            <td>{item.description}</td>
                                                            <td>{item.quantity}</td>
                                                            <td>{item.unitPrice}</td>
                                                            <td>{item.totalPrice}</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </>
                                    )}
                                    <p className="text-sm text-slate-500 mt-4">
                                        Confidence: {invoiceResult.confidence || 'N/A'}
                                    </p>
                                </div>
                            </>
                        );
                    case ImageCategory.OTHER:
                        const generalResult = result; // Type will be inferred correctly in TSX.
                        let subCategoryIcon = <GeneralIcon />;
                        let subCategoryTitle = 'General Image Analysis';

                        switch (generalResult.subCategory) {
                            case GeneralCategory.LOGO:
                                subCategoryTitle = 'Logo Analysis';
                                subCategoryIcon = <NetworkIcon />; // Reusing NetworkIcon as a generic icon
                                const logoResult = generalResult; // Specific cast for LogoAnalysis
                                return (
                                    <>
                                        <h3 className="text-xl font-semibold text-slate-200 mb-2 flex items-center">
                                            {subCategoryIcon} {subCategoryTitle}
                                        </h3>
                                        <p className="mb-3 text-sky-400 font-medium">
                                            Subject Category: <span className="font-bold">{logoResult.subCategory}</span>
                                        </p>
                                        <div className="prose">
                                            <p><strong>Company Name:</strong> {logoResult.companyName}</p>
                                            {logoResult.productName && <p><strong>Product Name:</strong> {logoResult.productName}</p>}
                                            <p><strong>Description:</strong> {logoResult.description}</p>
                                            <p><strong>Industry:</strong> {logoResult.industry}</p>
                                            {logoResult.website && <p><strong>Website:</strong> <a href={logoResult.website} target="_blank" rel="noopener noreferrer" className="text-sky-500 hover:underline">{logoResult.website}</a></p>}
                                            <p className="text-sm text-slate-500 mt-4">
                                                Confidence: {logoResult.confidence || 'N/A'}
                                            </p>
                                        </div>
                                    </>
                                );
                            case GeneralCategory.CELEBRITY:
                                subCategoryTitle = 'Celebrity Analysis';
                                subCategoryIcon = <GeneralIcon />;
                                const celebrityResult = generalResult; // Specific cast for CelebrityAnalysis
                                return (
                                    <>
                                        <h3 className="text-xl font-semibold text-slate-200 mb-2 flex items-center">
                                            {subCategoryIcon} {subCategoryTitle}
                                        </h3>
                                        <p className="mb-3 text-sky-400 font-medium">
                                            Subject Category: <span className="font-bold">{celebrityResult.subCategory}</span>
                                        </p>
                                        <div className="prose">
                                            <p><strong>Name:</strong> {celebrityResult.name}</p>
                                            <p><strong>Known For:</strong> {celebrityResult.knownFor}</p>
                                            <p><strong>Biography:</strong> {celebrityResult.biography}</p>
                                            {celebrityResult.notableWorks && celebrityResult.notableWorks.length > 0 && (
                                                <p><strong>Notable Works:</strong> {celebrityResult.notableWorks.join(', ')}</p>
                                            )}
                                            {celebrityResult.officialWebsite && <p><strong>Official Website:</strong> <a href={celebrityResult.officialWebsite} target="_blank" rel="noopener noreferrer" className="text-sky-500 hover:underline">{celebrityResult.officialWebsite}</a></p>}
                                            <p className="text-sm text-slate-500 mt-4">
                                                Confidence: {celebrityResult.confidence || 'N/A'}
                                            </p>
                                        </div>
                                    </>
                                );
                            case GeneralCategory.COOKED_FOOD:
                                subCategoryTitle = 'Cooked Food Analysis';
                                subCategoryIcon = <FruitIcon />; // Reusing FruitIcon for food
                                const cookedFoodResult = generalResult; // Specific cast for CookedFoodAnalysis
                                return (
                                    <>
                                        <h3 className="text-xl font-semibold text-slate-200 mb-2 flex items-center">
                                            {subCategoryIcon} {subCategoryTitle}
                                        </h3>
                                        <p className="mb-3 text-sky-400 font-medium">
                                            Subject Category: <span className="font-bold">{cookedFoodResult.subCategory}</span>
                                        </p>
                                        <div className="prose">
                                            <p><strong>Dish Name:</strong> {cookedFoodResult.dishName}</p>
                                            <p><strong>Estimated Ingredients:</strong> {cookedFoodResult.estimatedIngredients?.join(', ')}</p>
                                            <h4>Nutrition Estimate (per serving)</h4>
                                            <ul>
                                                <li>Calories: {cookedFoodResult.nutritionEstimate?.calories} kcal</li>
                                                <li>Protein: {cookedFoodResult.nutritionEstimate?.protein} g</li>
                                                <li>Carbs: {cookedFoodResult.nutritionEstimate?.carbs} g</li>
                                                <li>Fat: {cookedFoodResult.nutritionEstimate?.fat} g</li>
                                            </ul>
                                            <h4>Cooking Process</h4>
                                            <ol>
                                                {cookedFoodResult.cookingProcess?.map((step, i) => <li key={i}>{step}</li>)}
                                            </ol>
                                            {cookedFoodResult.allergenAlert && cookedFoodResult.allergenAlert.length > 0 && (
                                                <p className="text-red-400"><strong>Allergen Alert:</strong> {cookedFoodResult.allergenAlert.join(', ')}</p>
                                            )}
                                            <p className="text-sm text-slate-500 mt-4">
                                                Confidence: {cookedFoodResult.confidence || 'N/A'}
                                            </p>
                                        </div>
                                    </>
                                );
                            case GeneralCategory.ELECTRONIC_ITEM:
                                subCategoryTitle = 'Electronic Item Analysis';
                                subCategoryIcon = <GeneralIcon />; // Default general icon
                                const electronicItemResult = generalResult; // Specific cast for ElectronicItem
                                return (
                                    <>
                                        <h3 className="text-xl font-semibold text-slate-200 mb-2 flex items-center">
                                            {subCategoryIcon} {subCategoryTitle}
                                        </h3>
                                        <p className="mb-3 text-sky-400 font-medium">
                                            Subject Category: <span className="font-bold">{electronicItemResult.subCategory}</span>
                                        </p>
                                        <div className="prose">
                                            <p><strong>Item Name:</strong> {electronicItemResult.itemName}</p>
                                            {electronicItemResult.brand && <p><strong>Brand:</strong> {electronicItemResult.brand}</p>}
                                            {electronicItemResult.model && <p><strong>Model:</strong> {electronicItemResult.model}</p>}
                                            <p><strong>Description:</strong> {electronicItemResult.description}</p>
                                            {electronicItemResult.keyFeatures && electronicItemResult.keyFeatures.length > 0 && (
                                                <><h4>Key Features</h4><ul>{electronicItemResult.keyFeatures.map((feature, i) => <li key={i}>{feature}</li>)}</ul></>
                                            )}
                                            <p className="text-sm text-slate-500 mt-4">
                                                Confidence: {electronicItemResult.confidence || 'N/A'}
                                            </p>
                                        </div>
                                    </>
                                );
                            case GeneralCategory.PLANT:
                            case GeneralCategory.ANIMAL:
                            case GeneralCategory.SCENE:
                            case GeneralCategory.MANMADE_OBJECT:
                                subCategoryTitle = `${generalResult.subCategory.replace(/_/g, ' ')} Analysis`;
                                subCategoryIcon = <GeneralIcon />; // Default general icon
                                const plantAnimalSceneObjectResult = generalResult; // Specific cast for PlantAnimalSceneObject
                                return (
                                    <>
                                        <h3 className="text-xl font-semibold text-slate-200 mb-2 flex items-center">
                                            {subCategoryIcon} {subCategoryTitle}
                                        </h3>
                                        <p className="mb-3 text-sky-400 font-medium">
                                            Subject Category: <span className="font-bold">{plantAnimalSceneObjectResult.subCategory}</span>
                                        </p>
                                        <div className="prose">
                                            <p><strong>Description:</strong> {plantAnimalSceneObjectResult.description}</p>
                                            {plantAnimalSceneObjectResult.details && plantAnimalSceneObjectResult.details.length > 0 && (
                                                <><h4>Details</h4><ul>{plantAnimalSceneObjectResult.details.map((detail, i) => <li key={i}>{detail}</li>)}</ul></>
                                            )}
                                            {plantAnimalSceneObjectResult.tags && plantAnimalSceneObjectResult.tags.length > 0 && (
                                                <p><strong>Tags:</strong> {plantAnimalSceneObjectResult.tags.join(', ')}</p>
                                            )}
                                            <p className="text-sm text-slate-500 mt-4">
                                                Confidence: {plantAnimalSceneObjectResult.confidence || 'N/A'}
                                            </p>
                                        </div>
                                    </>
                                );
                            case GeneralCategory.GENERIC:
                            default: // Catches GENERIC explicitly or any unhandled subCategory as generic fallback
                                subCategoryTitle = 'Generic Image Analysis';
                                subCategoryIcon = <GeneralIcon />;
                                const genericResult = generalResult; // Specific cast for Generic
                                return (
                                    <>
                                        <h3 className="text-xl font-semibold text-slate-200 mb-2 flex items-center">
                                            {subCategoryIcon} {subCategoryTitle}
                                        </h3>
                                        <p className="mb-3 text-sky-400 font-medium">
                                            Subject Category: <span className="font-bold">{genericResult.subCategory}</span>
                                        </p>
                                        <div className="prose">
                                            <p><strong>Description:</strong> {genericResult.description}</p>
                                            {genericResult.tags && genericResult.tags.length > 0 && (
                                                <p><strong>Tags:</strong> {genericResult.tags.join(', ')}</p>
                                            )}
                                            <p className="text-sm text-slate-500 mt-4">
                                                Confidence: {genericResult.confidence || 'N/A'}
                                            </p>
                                        </div>
                                    </>
                                );
                        }
                    case ImageCategory.UNKNOWN:
                        const unknownResult = result; // Type will be inferred correctly in TSX.
                        return <ErrorView message={unknownResult.error || "Unknown category analysis failed."} />;
                }
                return null;
            };


            const isNetworkDiagram = result?.category === ImageCategory.NETWORK_DIAGRAM;

            return (
                <div className="bg-slate-800 p-6 rounded-lg shadow-lg h-full overflow-y-auto">
                    <h2 className="text-2xl font-bold mb-4 text-slate-100">Analysis Results</h2>

                    {isNetworkDiagram && (
                        <div className="mb-4 flex p-1 bg-slate-900 rounded-lg">
                            <button
                                onClick={() => setActiveResultTab('summary')}
                                className={`w-1/2 py-2 px-4 rounded-md text-sm font-medium transition-colors ${activeResultTab === 'summary' ? 'bg-sky-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}
                            >
                                Summary
                            </button>
                            <button
                                onClick={() => setActiveResultTab('code')}
                                className={`w-1/2 py-2 px-4 rounded-md text-sm font-medium transition-colors ${activeResultTab === 'code' ? 'bg-sky-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}
                            >
                                Terraform HCL
                            </button>
                        </div>
                    )}
                    
                    <div className="prose text-slate-300">
                        {renderDetails()}
                    </div>

                    {/* Always show raw JSON for debugging/transparency, unless it's a network diagram with a dedicated code tab */}
                    {(!isNetworkDiagram || activeResultTab === 'summary') && result && (
                        <>
                            <h2 className="text-2xl font-bold mt-8 mb-4 text-slate-100">Raw JSON Output</h2>
                            <CodeBlock code={JSON.stringify(result, null, 2)} language="json" />
                        </>
                    )}
                </div>
            );
        };


        // --- Main Application Component (Ported from App.tsx) ---

        const App = () => {
            const [image, setImage] = useState(null);
            const [imageMimeType, setImageMimeType] = useState(null);
            const [analysisResult, setAnalysisResult] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState(null);

            const handleImageSelect = (base64Data, mimeType) => {
                setImage(base64Data);
                setImageMimeType(mimeType);
                setAnalysisResult(null);
                setError(null);
            };

            const handleAnalyze = useCallback(async () => {
                if (!image || !imageMimeType) {
                    setError("Please select an image first.");
                    return;
                }

                setIsLoading(true);
                setError(null);
                setAnalysisResult(null);

                try {
                    const category = await classifyImage(image, imageMimeType);

                    let result = null;
                    switch (category) {
                        case ImageCategory.NETWORK_DIAGRAM:
                            const networkData = await analyzeNetworkDiagram(image, imageMimeType);
                            result = { category: ImageCategory.NETWORK_DIAGRAM, ...networkData };
                            break;
                        case ImageCategory.FRUIT:
                            const fruitData = await analyzeFruit(image, imageMimeType);
                            result = { category: ImageCategory.FRUIT, ...fruitData };
                            break;
                        // ADDED: New case for PULSES
                        case ImageCategory.PULSES:
                            const pulseData = await analyzePulses(image, imageMimeType);
                            result = { category: ImageCategory.PULSES, ...pulseData };
                            break;
                        case ImageCategory.INVOICE:
                            const invoiceData = await analyzeInvoice(image, imageMimeType);
                            result = { category: ImageCategory.INVOICE, ...invoiceData };
                            break;
                        case ImageCategory.OTHER:
                            const generalData = await analyzeGeneralImage(image, imageMimeType);
                            result = { category: ImageCategory.OTHER, ...generalData };
                            break;
                        default:
                            result = { category: ImageCategory.UNKNOWN, error: 'Could not determine image category.' };
                            break;
                    }
                    setAnalysisResult(result);
                } catch (err) {
                    console.error("Analysis failed:", err);
                    if (err instanceof Error && err.message) {
                        const errorMessage = err.message.toLowerCase();
                        if (errorMessage.includes('quota') || errorMessage.includes('rate limit') || errorMessage.includes('resource exhausted')) {
                            setError("The API is currently busy due to high demand. Please try again in a few moments.");
                        } else {
                            setError(`An unexpected error occurred during analysis: ${err.message}`);
                        }
                    } else {
                         setError("An unknown error occurred during analysis.");
                    }
                    // Clear the image on error to force re-upload
                    setImage(null);
                    setImageMimeType(null);
                } finally {
                    setIsLoading(false);
                }
            }, [image, imageMimeType]);

            const AnalyzeIcon = () => (
                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                    <path strokeLinecap="round" strokeLinejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.375 3.375 0 0014 18.442V21.75a1.5 1.5 0 01-3 0v-3.308c0-.442.07-.874.208-1.288l.548-.547z" />
                </svg>
            );

            return (
                <div className="min-h-screen bg-slate-900 text-slate-200">
                    <Header />
                    <main className="container mx-auto p-4 sm:p-6 lg:p-8">
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            {/* Left Column */}
                            <div className="space-y-6">
                                <ImageInput onImageSelect={handleImageSelect} isProcessing={isLoading} />
                                {image && (
                                    <div className="bg-slate-800 p-4 rounded-lg shadow-lg">
                                        <h3 className="text-lg font-semibold mb-4 text-slate-300">Image Preview</h3>
                                        <img src={`data:${imageMimeType};base64,${image}`} alt="Preview" className="rounded-md max-h-80 w-auto mx-auto"/>
                                    </div>
                                )}
                                <button
                                    onClick={handleAnalyze}
                                    disabled={!image || isLoading}
                                    className="w-full flex items-center justify-center bg-sky-600 hover:bg-sky-700 disabled:bg-slate-600 disabled:cursor-not-allowed text-white font-bold py-4 px-4 rounded-lg transition-colors text-lg"
                                >
                                    <AnalyzeIcon />
                                    {isLoading ? 'Analyzing...' : 'Analyze Image'}
                                </button>
                            </div>

                            {/* Right Column */}
                            <div className="h-full">
                                <AnalysisResult result={analysisResult} isLoading={isLoading} error={error} />
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        // --- Use modern createRoot API ---
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>